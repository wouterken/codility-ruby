
# This task would be easy if it weren't for Victor's ambition. He wants to outdo his neighbors with some truly beautiful lights, so the chain has to look the same from both its left and right sides (so that both neighbors see the same effect).

# Victor is a mechanic, so after buying a segment of the chain, he can rearrange its lights in any order he wants. However, now he has to buy a chain segment that will satisfy above condition when its lights are reordered. Can you compute how many possible segments he can choose from?

# Write a function:

# class Solution { public int solution(String S); }

# that, given a description of the chain of lights, returns the number of segments that Victor can buy modulo 1,000,000,007. The chain is represented by a string of digits (characters from '0' to '9') of length N. The digits represent the colors of the lights. Victor can only buy a segment of the chain in which he can reorder the lights such that the chain will look identical from both the left and right sides (i.e. when reversed).

# For example, given:

#     S = "02002"
#
#     "20002"
# the function should return 11. Victor can buy the following segments of the chain:

# "0", "2", "0", "0", "2", "00", "020", "200", "002", "2002", "02002"
# Note that a segment comprising a single "0" is counted three times: first it describes the subchain consisting of only the first light, then the subchain consisting of the third light and finally the subchain consisting of the fourth light. Also note that Victor can buy the whole chain ("02002"), as, after swapping the first two lights, it would become "20002", which is the same when seen from both from left and right.

# Assume that:

# string S consists only of digits (0âˆ’9);
# the length of S is within the range [1..200,000].
# Complexity:

# expected worst-case time complexity is O(N);
# expected wor
# st-case space complexity is O(1) (not counting the storage required for input arguments).


# 02002
# 12121, Table: { 0x3, 2x2 }, oe => (0e), odd_places: { 0x2, 2x1}
# 1210 , Table: { 0x2, 2x2 }, ee => (2o), odd_places: { 0x1, 2x1}
# 101  , Table: { 0x2, 2x1 }, eo => (0o), odd_places: { 0x1, 2x1}
# 12   , Table: { 0x1, 2x1 }, oo => (0e), odd_places: { 0x1, 2x1}
# 1    , Table: { 0x0, 2x1 }, eo => (2o), odd_places: { 0x0, 2x1}

# 02112
# 12321, Table: { 0x1, 1x2, 3x2}, oee
# 1210 , Table: { 0x0, 1x2, 3x2}, eee
# 101  , Table: { 0x0, 1x2, 3x1}, eeo
# 12   , Table: { 0x0, 1x1, 3x1}, eoo
# 1    , Table: { 0x0, 1x0, 3x1}, eeo


# 122151
# 121012,
# 10121 ,
# 1232  ,
# 121   ,
# 12    ,
# 1     ,

require 'pry'
require 'pry-byebug'


def solution(str)

  digits = 10
  mask   =  0
  table  = str.each_char.map {|char| mask = mask ^ (2 << (char.to_i - 1)) }

  mask, fails, max = 0, 0, str.length

  fact = ->(n){ n.downto(1).inject(:+) }
  count_bits = ->(x){ (x * 01001001001 & 042104210421) % 017}
  bit_counts = 1024.times.map{|i| count_bits[i] }

  counts = Hash.new(0)
  table.each{ |v| counts[v] += 1 }

  max.times do |i|
    current_count = table[i]
    fails = counts.reduce(fails){ |total, (odds, number)| bit_counts[odds ^ mask] > 1 ? total + number : total }
    mask = mask ^ (2 << (str[i].to_i - 1))
    counts[current_count] -= 1
  end
  (fact[str.length] - fails) % 1_000_000_007
end

puts solution("29") # 2
puts solution("02002") # 11
puts solution("03113") # 10
puts solution("122151") # 13
puts solution("1234554321") # 23
puts solution("1221551221") # 41
puts solution("122151121") # 22
puts solution("3759537919528750263297298647926144900705758776957360913510589342151316525212857604167440502811683427") # 181
puts solution("8444484884848484844888848844884448488884848484884484888888848484484444848884844484888488888444488844") # 3781
puts solution("484889") # 13
puts solution("020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020202020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020200202002020020200202002020020200202002020020200202002020020200202002020020200202002020020202")

starts = Time.now
puts solution(IO.read('/Users/pico/Desktop/input.txt'))
ends = Time.now
puts "Took #{ends - starts}"


